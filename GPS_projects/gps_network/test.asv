clc;clear all;format long g;
%There are five point
syms x309 x311 x315 x401 y309 y311 y315 y401 z309 z311 z315 z401 x402 y402 z402
[X0_402,Y0_402,Z0_402]=G2C([47 22 45.13567],[9 40 13.25647],460.223);
[X0_309,Y0_309,Z0_309]=G2C([47 23 42.1315],[9 39 06.7501],454.6084);
[X0_315,Y0_315,Z0_315]=G2C([47 23 2.52377],[9 38 20.12157],461.3014);
[X0_311,Y0_311,Z0_311]=G2C([47 23 12.44956],[9 38 14.81397],454.8585);
[X0_401,Y0_401,Z0_401]=G2C([47 23 33.30053],[9 40 04.10243],456.5356);
X0=[X0_309 Y0_309 Z0_309 X0_311 Y0_311 Z0_311 X0_315 Y0_315 Z0_315 X0_401 Y0_401 Z0_401 X0_402 Y0_402 Z0_402];
K=[x309-x401 ;y309-y401;z309-z401; x311-x315; y311-y315;z311-z315;x401-x315; y401-y315;z401-z315; x311-x309; y311-y309;z311-z309;x315-x309;...
   y315-y309;z315-z309; x315-x402; y315-y402; z315-z402; x401-x402; y401-y402; z401-z402;x309-x402;y309-y402;z309-z402] ;
Kx=[x309 y309 z309 x311 y311 z311 x315 y315 z315 x401 y401 z401 x402 y402 z402];
A=jacobian(K,Kx);A=eval(A);
l=[2.6393;-1219.6757;183.2147;-208.083; -148.2635; 202.817 ;-1058.5529;2032.2342;640.0422;847.839;-960.8186;-620.4315;1055.9127;-812.5601;-823.2508;...
 9.141;-2405.8049; 364.42232; -1049.413;-373.5771;1004.4573;-1046.7687;-1593.2419;1187.679];
Q1=0.1881*[.00000719,.0000007,.00000616;.0000007,.00000123,.00000055;.00000616,.00000055,.00000867];
Q2=0.1965*[.00000752,.00000175,.00000301;.00000175,.00000177,.00000111;.00000301,.00000111,.00000502];
Q3=0.2703*[.00000851,.00000108,.00000525;.00000108,.00000154,.00000064;.00000525,.00000064,.00000696];
Q4=0.2852*[.0000046,.00000104,.00000228;.00000104,.00000201,.00000616;.00000228,.00000616,.0000204];
Q5=0.2336*[.00000567,.00000117,.00000167;.00000117,.00000178,.00000187;.00000167,.00000187,.0000095];
Q6=0.2704*[.00000443,.00000082,.00000232;.00000082,.00000102,.00000038;.00000232,.00000038,.00000543];
Q7=0.2312*[.00000433,.00000072,.00000235;.00000072,.00000099,.00000052;.00000235,.00000052,.00000672];
Q8=0.2497*[.00000545,.00000096,.0000027;.00000096,.00000143,.00000125;.0000027,.00000125,.00001065];
Q=blkdiag(Q1,Q2,Q3,Q4,Q5,Q6,Q7,Q8);
p=inv(Q);
Ax(3,15)=0;Ax(1,1)=1;Ax(2,2)=1;Ax(3,3)=1;
px=diag([1/.001^2 1/.001^2 1/.001^2]);
lx=[X0_309 Y0_309 Z0_309]';
x_hat=inv(A'*p*A+Ax'*px*Ax)*(A'*p*l+Ax'*px*lx)
Cx_hat=inv(A'*p*A);
l_hat=A*x_hat;
v_hat=l-l_hat;
l_hatx=Ax*x_hat;
v_hatx=lx-l_hatx;
sigma02_hat=((v_hat'*p*v_hat)+(v_hatx'*px*v_hatx))/9
ret=test_sigma02(sigma02_hat,1,9,.05)
% mgh=[X0_309-X0_401 ;Y0_309-Y0_401;Z0_309-Z0_401; X0_311-X0_315; Y0_311-Y0_315;Z0_311-Z0_315;X0_401-X0_315; Y0_401-Y0_315;Z0_401-Z0_315; X0_311-X0_309; Y0_311-Y0_309;Z0_311-Z0_309;X0_315-X0_309;...
%    Y0_315-Y0_309;Z0_315-Z0_309; X0_315-X0_402; Y0_315-Y0_402; Z0_315-Z0_402; X0_401-X0_402; Y0_401-Y0_402; Z0_401-Z0_402;X0_309-X0_402;Y0_309-Y0_402;Z0_309-Z0_402]
% ll=[2.6393;-1219.6757;183.2147;-208.083; -148.2635; 202.817 ;-1058.5529;2032.2342;640.0422;847.839;-960.8186;-620.4315;1055.9127;-812.5601;-823.2508;...
%  9.141;-2405.8049; 364.4223; -1049.413;-373.5771;1004.4573;-1046.7687;-1593.2419;1187.679];